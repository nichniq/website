<!doctype html>

<html lang="en">
    <head>
        <title>Nick Cassleman - Library catalog</title>

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <script>
            function Row(mapping = {}) {
                return {
                    mapping: () => mapping,
                    headings: () => Object.keys(mapping),
                    columns: () => Object.values(mapping),
                };
            }

            function Book(model = {}) {
                // helpers

                const id = (ids = [], search) => ids.reduce(
                    (id, [ type, data ]) => type === search ? data : id,
                    undefined
                );

                const firstTxn = ([ [ type, data ] = [] ] = []) => ({
                    date: data?.date,
                    location: data?.location,
                    city: data?.city,
                    method: type,
                });

                // alternate representations

                const mapping = (model) => ({
                    "Title":             model.title                   || "",
                    "Subtitle":          model.subtitle                || "",
                    "Series":            model.series                  || "",
                    "ISBN":              id(model.ids, "isbn10")       || "",
                    "ISBN-13":           id(model.ids, "isbn13")       || "",
                    "LCCN":              id(model.ids, "lccn")         || "",
                    "External link":     model.external                || "",
                    "Date acquired":     firstTxn(model.txns).date     || "",
                    "Location acquired": firstTxn(model.txns).location || "",
                    "City acquired":     firstTxn(model.txns).city     || "",
                    "Method acquired":   firstTxn(model.txns).method   || "",
                    "Notes":             model.notes                   || "",
                });

                // transformation API

                return {
                    model: () => model,
                    row: () => Row(mapping(model)),
                };
            }
        </script>

        <script>
            function element(tag, content = [], attributes = {}) {
                const element = document.createElement(tag);

                for ( const child of [ content ].flat(1) ) {
                    element.appendChild(child);
                }

                for ( const [ name, value ] of Object.entries(attributes) ) {
                    element.setAttribute(name, value);
                }

                return element;
            }
        </script>

        <script>
            /**
             * There are a lot of ways I could slice this one. I wasn't sure
             * what I should compose, what I should repeat, what I should pass
             * in. The new introduction is the `element` shorthand.
             */

            function tableFromBooks(books) {
                const headings = Book().row().headings();
                const rows = books.map(Book).map((book) => book.row().columns());

                const text = (content) => document.createTextNode(content);
                const row = (type) => (cells) => element("tr",
                    cells.map(
                        (col) => element(type, text(col))
                    )
                );

                return element("table",
                    [
                        element("thead", row("th")(headings)),
                        element("tbody", rows.map(row("td"))),
                    ]
                );
            }
        </script>
    </head>

    <body>
        <template id="table-placeholder"></template>

        <script type="module">
            import catalog from "./catalog.js";

            document.getElementById("table-placeholder").replaceWith(
                tableFromBooks(catalog)
            );
        </script>
    </body>
</html>
