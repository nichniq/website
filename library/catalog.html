<!doctype html>

<html lang="en">
    <head>
        <title>Nick Cassleman - Library catalog</title>

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <link rel="stylesheet" type="text/css" href="/globals.css" />

        <style>
            table {
                text-align: left;
                background-color: white;
            }

            thead {
                background-color: inherit;
                position: sticky;
                top: 0;
            }

            thead > tr:last-child > th {
                border-bottom: 1px solid black;
                padding: 0.5em;
            }

            tbody > tr > td {
                padding: 0.25em 0.5em;
            }
        </style>
    </head>

    <body>
        <h1>
            <a href="/">Nick Cassleman</a> -
            <a href="/library.html">Home library</a> -
            Library catalog
        </h1>

        <noscript id="noscript">
            <p>
                This page dynamically renders the catalog with JavaScript. Instead, you may view the <a href="/library/catalog.js">catalog data</a> directly.
            </p>
        </noscript>

        <script type="module" id="catalog-generator">
            import books from "./catalog.js";

            import { text, element, tags } from "/scripts/html.js";
            const { cite, abbr, a, tr, table, th, td, thead, tbody } = tags;

            const ISBN13 = "International Standard Book Number, 13-digit";
            const ISBN10 = "International Standard Book Number, 10-digit";
            const LCCN = "Library of Congress Control Number";

            const maybe = (truthy, array) => truthy ? array : [];
            const first = (arrays) => arrays.find((x) => x.length > 0) || [];
            const unzip = (entries) => {
                const map = Object.fromEntries(entries);
                return [ Object.keys(map), Object.values(map) ];
            };

            const title = ({ title, subtitle, series }) => [
                ...cite(
                    [
                        ...text(title),
                        ...maybe(subtitle, text(`: ${subtitle}`)),
                    ],
                    { "data-medium": "book" }
                ),
                ...maybe(series, text(` (${series})`)),
            ];

            const id = ({ ids = [] }) => {
                const { isbn13, isbn10, lccn } = Object.fromEntries(ids);

                const option = (short, title, content) => maybe(content, [
                    ...abbr(text(short), { title }),
                    ...text(`: ${content}`),
                ]);

                return first([
                    option("ISBN13", ISBN13, isbn13),
                    option("LCCN", LCCN, lccn),
                    option("ISBN10", ISBN10, isbn10),
                ]);
            };

            const link = ({ title, external }) => maybe(external,
                a(text("link"), {
                    title,
                    href: external,
                    referrerpolicy: "no-referrer",
                    rel: "noopener",
                })
            );

            const city = ({ txns = [] }) => {
                const [ first ] = txns;
                const [ method, { city } = {} ] = first || [];

                return maybe(city, text(city));
            };

            const date = ({ txns = [] }) => {
                const [ first ] = txns;
                const [ method, { date } = {} ] = first || [];

                return maybe(date, text(date));
            };

            const [ titles, columns ] = unzip([
                [ "Title", title ],
                [ "ID", id ],
                [ "Link", link ],
                [ "Date", date ],
                [ "City", city ],
            ]);

            const [ catalog ] = table([
                ...thead(
                    tr(
                        titles.flatMap((title) => th(text(title)))
                    )
                ),
                ...tbody(
                    books.flatMap(
                        (book) => tr(
                            columns.flatMap((col) => td(col(book)))
                        )
                    )
                ),
            ]);

            document.getElementById("noscript").remove();
            document.getElementById("catalog-generator").replaceWith(catalog);
        </script>
    </body>
</html>
