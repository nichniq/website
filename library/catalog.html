<!doctype html>

<html lang="en">
    <head>
        <title>Nick Cassleman - Library catalog</title>

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <link rel="stylesheet" type="text/css" href="/globals.css" />

        <style>
            table {
                background-color: white;
                border-collapse: collapse;
                text-align: left;
            }

            thead {
                background-color: inherit;
                position: sticky;
                top: 0;
            }

            thead::after {
                display: block;
                content: "";
                background-color: black;
                height: 1px;
                position: absolute;
                left: 0;
                right: 0;
                bottom: 0;
            }

            thead > tr > th {
                padding: 0.5em;
            }

            tbody > tr > td {
                padding: 0.25em 0.5em;
            }
        </style>
    </head>

    <body>
        <h1>
            <a href="/">Nick Cassleman</a> -
            <a href="/library.html">Home library</a> -
            Library catalog
        </h1>

        <noscript id="noscript">
            <p>
                This page dynamically renders the catalog with JavaScript. Instead, you may view the <a href="/library/catalog.js">catalog data</a> directly.
            </p>
        </noscript>

        <script type="module" id="catalog-generator">
            import books from "./catalog.js";

            /**
             * The data in catalog.js is an array of these
             * All fields are optional/empty except title
             *
             * {
             *     title: "300 Art Nouveau Designs and Motifs in Full Color",
             *     subtitle: undefined, // string otherwise
             *     series: undefined, // string otherwise
             *     ids: [
             *         [ "isbn10", "0486243540" ],
             *         [ "isbn13", "9780486243542" ],
             *     ],
             *     external: "https://www.goodreads.com/...",
             *     txns: [
             *         [ "purchase", {
             *             date: "January 18, 2020",
             *             location: "Dog Eared Books (Valencia)",
             *             city: "San Francisco" }
             *         ],
             *     ],
             *     notes: undefined, // string otherwise
             * }
             */

            import { element } from "/modules/element.js";
            import { tags } from "/modules/tags.js";

            const { cite, abbr, a, tr, table, th, td, thead, tbody } = tags;

            const ISBN13 = "International Standard Book Number, 13-digit";
            const ISBN10 = "International Standard Book Number, 10-digit";
            const LCCN = "Library of Congress Control Number";

            const maybe = (truthy, array) => truthy ? array : [];
            const first = (arrays) => arrays.find((x) => x.length > 0) || [];
            const unzip = (entries) => {
                const map = Object.fromEntries(entries);
                return [ Object.keys(map), Object.values(map) ];
            };

            const title = ({ title, subtitle, series }) => [
                cite([
                        title,
                        maybe(subtitle, `: ${subtitle}`),
                    ],
                    { "data-medium": "book" }
                ),
                maybe(series, ` (${series})`),
            ];

            const id = ({ ids = [] }) => {
                const { isbn13, isbn10, lccn } = Object.fromEntries(ids);

                const option = (short, title, content) => maybe(content,
                    [ abbr(short, { title }), `: ${content}` ]
                );

                return first([
                    option("ISBN13", ISBN13, isbn13),
                    option("LCCN", LCCN, lccn),
                    option("ISBN10", ISBN10, isbn10),
                ]);
            };

            const link = ({ title, external }) => maybe(external,
                a("link", {
                    title,
                    href: external,
                    referrerpolicy: "no-referrer",
                    rel: "noopener",
                })
            );

            const city = ({ txns = [] }) => {
                const txn = first(txns);
                const [ method, { city } = {} ] = txn;

                return maybe(city, city);
            };

            const date = ({ txns = [] }) => {
                const txn = first(txns);
                const [ method, { date } = {} ] = txn;

                return maybe(date, date);
            };

            const [ titles, columns ] = unzip([
                [ "Title", title ],
                [ "ID", id ],
                [ "Link", link ],
                [ "Date", date ],
                [ "City", city ],
            ]);

            const [ catalog ] = table([
                thead(
                    tr(
                        titles.map((title) => th(title))
                    )
                ),
                tbody(
                    books.map(
                        (book) => tr(
                            columns.map((col) => td(col(book)))
                        )
                    )
                ),
            ]);

            document.getElementById("noscript").remove();
            document.getElementById("catalog-generator").replaceWith(catalog);
        </script>
    </body>
</html>
