<!doctype html>

<title>Part One</title>

<style>
  body { margin: 0 }
  *:first-child { margin-top: 0 }
  *:last-child { margin-bottom: 0 }

  .outline {
    height: 100vh;
    display: flex;
    flex-direction: row;
    flex-wrap: nowrap;
    gap: 15px;
  }

  .generation {
    flex: 0 0 60ch;
    overflow: hidden scroll;
    background-color: rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .node {
    background-color: rgba(255, 255, 255, 0.5);
  }

  .node:hover {
    background-color: rgba(255, 255, 0, 0.5);
  }

  .lineage {
    background-color: rgba(255, 0, 255, 0.5);
  }

  .active {
    background-color: rgba(0, 255, 255, 0.5);
  }
</style>

<body></body>

<script type="module">
  import { tags } from "/modules/element.js";
  import render_md from "./markdown.js";
  import hierarchy from "./hierarchy.js";

  const fetch_json = path => fetch(path).then(response => response.json());
  const expose = o => Object.entries(o).forEach(([k,v]) => window[k] = v);
  const print = o => Object.entries(o).forEach(([k,v]) => console.log(k, v));

  const part_one = hierarchy(await fetch_json("./part-one.json"));

  const node_to_element = new Map();
  const element_to_node = new Map();

  function tree_to_ui(tree) {
    const generations = tree.descendants(tree.root);
    const [ ui ] = tags.div(
      [ [ tree.root ], ...generations ].map(
        generation => tags.div(
          generation.flat().map(
            node => {
              const [ element ] = tags.div(
                render_md(node.content, false),
                { class: "node" }
              );
              element_to_node.set(element, node);
              node_to_element.set(node, element);
              return element;
            },
          ),
          { class: "generation" }
        )
      ),
      { class: "outline" },
    );
    return ui;
  }

  const ui = tree_to_ui(part_one);
  document.body.append(ui);

  ui.addEventListener('click', event => {
    const element = event.target.closest(".node");

    if (element == null) return;

    const node = element_to_node.get(element);
    const ancestors = part_one.ancestors(node);
    const descendants = part_one.descendants(node);

    for (const x of [ ...ancestors, node, ...descendants.flatMap(d => d[0]) ]) {
      node_to_element.get(x).scrollIntoView({ behavior: "smooth" });
    }

    for (const x of document.querySelectorAll(".lineage")) {
      x.classList.remove("lineage");
    }

    const lineage = [
    ...ancestors,
    ...part_one.descendants(ancestors[0]).flat(Infinity),
    ];

    for (const x of lineage) {
      node_to_element.get(x).classList.add("lineage");
    }

    for (const x of document.querySelectorAll(".active")) {
      x.classList.remove("active");
    }

    element.classList.add("active");
  });
</script>
