<!doctype html>

<title>Part One</title>

<style>
  body {
    margin: 0;
  }

  *:first-child {
    margin-top: 0;
  }

  *:last-child {
    margin-bottom: 0;
  }

  .outline {
    height: 100vh;
    display: flex;
    flex-direction: row;
    flex-wrap: nowrap;
    gap: 15px;
  }

  .generation {
    flex: 0 0 300px;
    overflow: hidden scroll;
    background-color: rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .node {
    background-color: rgba(255, 255, 255, 0.5);
  }

  .node:hover {
    background-color: rgba(255, 255, 200, 0.5);
  }
</style>

<body></body>

<script type="module">
  import { tags } from "/modules/element.js";
  import gingko from "./scripts/import_gingko.js";
  import render_md from "./scripts/markdown.js";

  const { ol, li, textarea, div } = tags;
  const publish = obj => Object.entries(obj).forEach(([k,v]) => window[k] = v);
  const print = obj => Object.entries(obj).forEach(([k,v]) => console.log(k, v));

  const {
    origin, registry, ids, generations, ancestors, descendants, lineage
  } = await gingko("./gingko-export.json");
  const elements = {};

  publish({ elements, origin, registry, generations, ancestors, descendants });
  print({ elements, origin, registry, generations, ancestors, descendants });

  const node_to_ui = node => {
    const id = registry.get(node);
    const [ element ] = div(
      render_md(node.content, false),
      { class: "node", "data-id": id }
    );
    elements[id] = element;
    return element;
  };

  const generation_to_ui = generation => div(
    generation.map(id => node_to_ui(ids[id])),
    { class: "generation" },
  );

  const generations_to_ui = generations => div(
    generations.map(gen => generation_to_ui(gen)),
    { class: "outline" },
  );

  const [ ui ] = generations_to_ui(generations);
  document.body.append(ui);

  ui.addEventListener('click', event => {
    const node = event.target.closest(".node");
    if (node == null) return;
    const { id } = node.dataset;
    const [ root, ...eldests ] = lineage(id);

    for (const eldest_id of eldests) {
      const first = elements[eldest_id];
      first.scrollIntoView({ behavior: "smooth" })
    }
  });
</script>
