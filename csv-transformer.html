<!doctype html>

<html lang="en">
    <head>
        <title>Nick Cassleman - CSV transformer</title>

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <style>
            .block { display: block }
            .full-width { width: 100% }
            .preformatted { white-space: pre }
            .bold { font-weight: bold }
        </style>
    </head>

    <body>
        <form>
            <label class="bold">
                CSV data

                <textarea
                    id="csv-input"
                    name="csv"
                    rows="10"
                    class="full-width preformatted block"
                ></textarea>
            </label>

            <button>Parse</button>

            <output style="display: block; padding-top: 3rem">
                <label class="bold">
                    Result

                    <textarea
                        id="csv-output"
                        for="csv-input"
                        readonly
                        rows="10"
                        class="full-width preformatted block"
                    ></textarea>
                </label>
            </output>
        </form>

        <script>
            function *splitRow(row) {
                let queue = [];
                let insideQuote = false;

                for (const char of row) {
                    if (insideQuote && char === ",") {
                        queue.push(char);
                    } else if (!insideQuote && char === ",") {
                        yield queue.join("");
                        queue = [];
                    } else if (char === '"') {
                        insideQuote = !insideQuote;
                    } else {
                        queue.push(char);
                    }
                }

                yield queue.join("");
            }

            function bookFromRow(row) {
                const fields = [ ...splitRow(row) ];

                return `
{
    title: "${fields[0]}",
    subtitle: "${fields[1]}",
    series: "${fields[2]}",
    ids: [
        [ "isbn10", "${fields[3]}" ],
        [ "isbn13", "${fields[4]}" ],
        [ "lccn", "${fields[5]}" ],
    ],
    external: "${fields[6]}",
    tnxs: [
        [ "${fields[10].toLowerCase()}", { date: "${fields[7]}", location: "${fields[8]}", city: "${fields[9]}" } ],
    ],
    notes: "${fields[11]}",
},
                `.trim();
            }

            document.onsubmit = function captureSubmission(submission) {
                submission.preventDefault();

                const form = submission.target;
                const action = new URL(form.action).pathname;
                const data = Object.fromEntries(new FormData(form).entries());
                const [ header, ...rows ] = data.csv.split("\n");

                document.getElementById("csv-output").value = rows.map(
                    (row) => bookFromRow(row)
                ).join("\n");
            }
        </script>
    </body>
</html>
