<!doctype html>

<html lang="en">
    <head>
        <title>Nick Cassleman - CSV transformer</title>

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <style>
            .block { display: block }
            .full-width { width: 100% }
            .preformatted { white-space: pre }
            .bold { font-weight: bold }
        </style>
    </head>

    <body>
        <form>
            <label class="bold">
                CSV data

                <textarea
                    id="csv-input"
                    name="csv"
                    rows="10"
                    class="full-width preformatted block"
                ></textarea>
            </label>

            <button>Parse</button>

            <output style="display: block; padding-top: 3rem">
                <label class="bold">
                    Result

                    <textarea
                        id="csv-output"
                        for="csv-input"
                        readonly
                        rows="10"
                        class="full-width preformatted block"
                    ></textarea>
                </label>
            </output>
        </form>

        <script>
            function *splitRow(row) {
                let queue = [];
                let insideQuote = false;

                for (const char of row) {
                    if (insideQuote && char === ",") {
                        queue.push(char);
                    } else if (!insideQuote && char === ",") {
                        yield queue.join("");
                        queue = [];
                    } else if (char === '"') {
                        insideQuote = !insideQuote;
                    } else {
                        queue.push(char);
                    }
                }

                yield queue.join("");
            }

            function bookFromRow(row) {
                return {
                    title: row[0],
                    subtitle: row[1],
                    series: row[2],
                    id: {
                        isbn10: row[3],
                        isbn13: row[4],
                        lccn: row[5],
                    },
                    external: row[6],
                    tnxs: [
                        {
                            date: row[7]
                            location: row[8],
                            city: row[9]
                            method: row[10],
                        }
                    ],
                    notes: row[11]
                }
            }

            document.onsubmit = function captureSubmission(submission) {
                submission.preventDefault();

                const form = submission.target;
                const action = new URL(form.action).pathname;
                const data = Object.fromEntries(new FormData(form).entries());
                const [ header, ...rows ] = data.csv.split("\n");

                debugger;

                document.getElementById("csv-output").value = data.csv + "!";
            }
        </script>
    </body>
</html>
